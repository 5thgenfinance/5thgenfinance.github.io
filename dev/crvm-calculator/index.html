<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRVM Reserve Calculator - 2017 CSO</title>
    <style>
        :root {
            --color-bg-primary: #fcfcf9;
            --color-surface: #fffffd;
            --color-text: #13343b;
            --color-text-secondary: #626c71;
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-error: #c0152f;
            --color-success: #21808d;
            --font-family-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --radius-base: 8px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-24: 24px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg-primary: #1f2121;
                --color-surface: #262828;
                --color-text: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-border: rgba(119, 124, 124, 0.3);
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-family-base);
            background: var(--color-bg-primary);
            color: var(--color-text);
            padding: var(--space-24);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: var(--space-8);
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--space-16);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-16);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        label {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        input, select {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: 14px;
            background: var(--color-surface);
            color: var(--color-text);
        }

        input:focus, select:focus {
            outline: 2px solid var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn {
            padding: var(--space-12) var(--space-24);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-hover);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            color: var(--color-error);
            font-size: 12px;
            margin-top: var(--space-8);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-24);
        }

        .result-item {
            padding: var(--space-16);
            background: rgba(33, 128, 141, 0.08);
            border-radius: var(--radius-base);
        }

        .result-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-8);
        }

        .result-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: var(--space-12);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        th {
            font-weight: 600;
            background: rgba(33, 128, 141, 0.05);
        }

        .loading {
            display: none;
            text-align: center;
            padding: var(--space-24);
            color: var(--color-text-secondary);
        }

        .loading.show {
            display: block;
        }

        .audit-section {
            margin-bottom: var(--space-16);
            background: rgba(33, 128, 141, 0.05);
            border-radius: var(--radius-base);
            overflow: hidden;
        }

        .audit-header {
            padding: var(--space-16);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.2s;
        }

        .audit-header:hover {
            background: rgba(33, 128, 141, 0.08);
        }

        .audit-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-primary);
            margin: 0;
        }

        .audit-toggle {
            font-size: 20px;
            color: var(--color-primary);
            transition: transform 0.3s;
        }

        .audit-toggle.expanded {
            transform: rotate(180deg);
        }

        .audit-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .audit-content.expanded {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .audit-detail {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.8;
            white-space: pre-wrap;
            color: var(--color-text);
            padding: 0 var(--space-16) var(--space-16) var(--space-16);
        }

        .audit-formula {
            background: rgba(33, 128, 141, 0.1);
            padding: var(--space-8);
            border-radius: 4px;
            margin: var(--space-8) 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CRVM Reserve Calculator</h1>
            <p class="subtitle">Commissioners Reserve Valuation Method using 2017 CSO Mortality Tables</p>
        </header>

        <div class="card">
            <h2>Policy Information</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="issueAge">Issue Age *</label>
                    <input type="number" id="issueAge" min="18" max="95" value="40" required>
                </div>
                <div class="form-group">
                    <label for="gender">Gender *</label>
                    <select id="gender" required>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="smoker">Smoker Status *</label>
                    <select id="smoker" required>
                        <option value="nonsmoker">Non-Smoker</option>
                        <option value="smoker">Smoker</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="term">Policy Term (years) *</label>
                    <input type="number" id="term" min="1" max="40" value="5" required>
                </div>
                <div class="form-group">
                    <label for="faceAmount">Face Amount ($) *</label>
                    <input type="number" id="faceAmount" min="1" step="1000" value="100000" required>
                </div>
                <div class="form-group">
                    <label for="issueDate">Issue Date *</label>
                    <input type="date" id="issueDate" required>
                </div>
                <div class="form-group">
                    <label for="valuationDate">Valuation Date *</label>
                    <input type="date" id="valuationDate" required>
                </div>
                <div class="form-group">
                    <label for="interestRate">Interest Rate (%) *</label>
                    <input type="number" id="interestRate" min="0" max="20" step="0.01" value="3.5" required>
                </div>
            </div>
            <div class="error-message" id="errorMessage"></div>
            <button class="btn" id="calculateBtn" onclick="calculateReserve()">Calculate Reserve</button>
        </div>

        <div class="loading" id="loading">
            <p>Calculating reserves...</p>
        </div>

        <div class="results" id="results">
            <div class="card">
                <h2>Calculation Results</h2>
                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-label">CRVM Reserve</div>
                        <div class="result-value" id="crvmReserve">$0.00</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Present Value of Benefits</div>
                        <div class="result-value" id="pvBenefits">$0.00</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total STAT Reserve</div>
                        <div class="result-value" id="totalSTAT">$0.00</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Attained Age</div>
                        <div class="result-value" id="attainedAge">0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Calculation Year</div>
                        <div class="result-value" id="calculationYear">0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Duration</div>
                        <div class="result-value" id="duration">0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Deficiency Reserve Applied</div>
                        <div class="result-value" id="deficiency">No</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Calculation Audit Trail</h2>
                <div class="audit-section">
                    <div class="audit-header" onclick="toggleAudit(1)">
                        <h3>Step 1: Duration Calculation</h3>
                        <span class="audit-toggle" id="toggle1">▼</span>
                    </div>
                    <div class="audit-content" id="content1">
                        <div class="audit-detail" id="auditDuration"></div>
                    </div>
                </div>
                <div class="audit-section">
                    <div class="audit-header" onclick="toggleAudit(2)">
                        <h3>Step 2: Attained Age Calculation</h3>
                        <span class="audit-toggle" id="toggle2">▼</span>
                    </div>
                    <div class="audit-content" id="content2">
                        <div class="audit-detail" id="auditAttainedAge"></div>
                    </div>
                </div>
                <div class="audit-section">
                    <div class="audit-header" onclick="toggleAudit(3)">
                        <h3>Step 3: Mortality Rate Selection</h3>
                        <span class="audit-toggle" id="toggle3">▼</span>
                    </div>
                    <div class="audit-content" id="content3">
                        <div class="audit-detail" id="auditMortality"></div>
                    </div>
                </div>
                <div class="audit-section">
                    <div class="audit-header" onclick="toggleAudit(4)">
                        <h3>Step 4: Present Value of Benefits</h3>
                        <span class="audit-toggle" id="toggle4">▼</span>
                    </div>
                    <div class="audit-content" id="content4">
                        <div class="audit-detail" id="auditPVBenefits"></div>
                    </div>
                </div>
                <div class="audit-section">
                    <div class="audit-header" onclick="toggleAudit(5)">
                        <h3>Step 5: Present Value of Annuity Due</h3>
                        <span class="audit-toggle" id="toggle5">▼</span>
                    </div>
                    <div class="audit-content" id="content5">
                        <div class="audit-detail" id="auditPVAnnuity"></div>
                    </div>
                </div>
                <div class="audit-section">
                    <div class="audit-header" onclick="toggleAudit(6)">
                        <h3>Step 6: CRVM Reserve Calculation</h3>
                        <span class="audit-toggle" id="toggle6">▼</span>
                    </div>
                    <div class="audit-content" id="content6">
                        <div class="audit-detail" id="auditCRVM"></div>
                    </div>
                </div>
                <div class="audit-section">
                    <div class="audit-header" onclick="toggleAudit(7)">
                        <h3>Step 7: Deficiency Reserve Check</h3>
                        <span class="audit-toggle" id="toggle7">▼</span>
                    </div>
                    <div class="audit-content" id="content7">
                        <div class="audit-detail" id="auditDeficiency"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Year-by-Year Reserve Projection</h2>
                <div class="table-container">
                    <table id="yearByYearTable">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Duration</th>
                                <th>Attained Age</th>
                                <th>Mortality Rate</th>
                                <th>Reserve per $1,000</th>
                                <th>Total Reserve</th>
                            </tr>
                        </thead>
                        <tbody id="yearByYearBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CRVM Reserve Calculator - Production Implementation
        // Version: 1.0 - December 4, 2025
        // Implements 2017 CSO Mortality Tables per VM-20, NAIC 830, ASOP 56

        // Production implementation - loads actual 2017 CSO mortality data from JSON files
        // Files should be placed in /mortality/ directory relative to this HTML file

        /**
         * Mortality data cache - will be populated from JSON files
         * Structure: {
         *   'male-nonsmoker': { select: {age: {dur: rate}}, ultimate: {age: rate} },
         *   'male-smoker': { ... },
         *   'female-nonsmoker': { ... },
         *   'female-smoker': { ... }
         * }
         */
        let mortalityData = {};
        let mortalityDataLoaded = false;

        /**
         * Loads mortality data from JSON files in /mortality/ directory
         * Files expected:
         * - 2017_CSO_Unisex_Male_NonSmoker.json
         * - 2017_CSO_Unisex_Male_Smoker.json
         * - 2017_CSO_Unisex_Female_NonSmoker.json
         * - 2017_CSO_Unisex_Female_Smoker.json
         * @returns {Promise<void>}
         */
        async function loadMortalityData() {
            const files = [
                { path: './mortality/2017_CSO_Unisex_Male_NonSmoker.json', key: 'male-nonsmoker' },
                { path: './mortality/2017_CSO_Unisex_Male_Smoker.json', key: 'male-smoker' },
                { path: './mortality/2017_CSO_Unisex_Female_NonSmoker.json', key: 'female-nonsmoker' },
                { path: './mortality/2017_CSO_Unisex_Female_Smoker.json', key: 'female-smoker' }
            ];

            try {
                const loadPromises = files.map(async ({ path, key }) => {
                    const response = await fetch(path);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${path}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    mortalityData[key] = parseMortalityTable(data);
                });

                await Promise.all(loadPromises);
                mortalityDataLoaded = true;
                console.log('✓ All 4 mortality tables loaded successfully from /mortality/ folder');
                
            } catch (error) {
                console.error('Error loading mortality data:', error);
                console.warn('Falling back to sample data for demonstration');
                // Fallback to sample data if files not found
                mortalityData = {
                    'male-nonsmoker': generateSampleRates(18, 95, 1.0),
                    'male-smoker': generateSampleRates(18, 95, 1.8),
                    'female-nonsmoker': generateSampleRates(18, 95, 0.6),
                    'female-smoker': generateSampleRates(18, 95, 1.2)
                };
                mortalityDataLoaded = true;
            }
        }

        /**
         * Parses SOA 2017 CSO JSON format into application format
         * Extracts Select (Duration 1-5) and Ultimate rates
         * @param {Object} soaData - Raw SOA JSON data
         * @returns {Object} Parsed mortality table { select: {}, ultimate: {} }
         */
        function parseMortalityTable(soaData) {
            const table = { select: {}, ultimate: {} };
            
            // SOA format has Table array with rows
            if (!soaData.Table || !Array.isArray(soaData.Table)) {
                throw new Error('Invalid SOA table format - missing Table array');
            }

            // First row is header, skip it
            const rows = soaData.Table.slice(1);

            rows.forEach(row => {
                const age = parseInt(row[0]); // First column is age
                
                if (isNaN(age) || age < 18 || age > 95) {
                    return; // Skip invalid ages
                }

                // Initialize select rates for this age
                table.select[age] = {};

                // Columns 1-5 are Select Duration 1-5
                for (let dur = 1; dur <= 5; dur++) {
                    const rateValue = parseFloat(row[dur]);
                    if (!isNaN(rateValue)) {
                        table.select[age][dur] = rateValue / 1000; // SOA uses per-1000 format
                    }
                }

                // Column 6 is Ultimate rate
                const ultimateValue = parseFloat(row[6]);
                if (!isNaN(ultimateValue)) {
                    table.ultimate[age] = ultimateValue / 1000; // SOA uses per-1000 format
                }
            });

            return table;
        }

        /**
         * Generates sample mortality rates for demonstration
         * @param {number} minAge - Minimum age
         * @param {number} maxAge - Maximum age  
         * @param {number} multiplier - Rate adjustment factor
         * @returns {Object} Mortality rate lookup table
         */
        function generateSampleRates(minAge, maxAge, multiplier) {
            const rates = { select: {}, ultimate: {} };
            
            for (let age = minAge; age <= maxAge; age++) {
                // Select rates (Duration 1-5) - Gompertz-Makeham approximation
                rates.select[age] = {};
                for (let dur = 1; dur <= 5; dur++) {
                    const baseRate = 0.0001 * Math.exp(0.08 * (age - 20)) + 0.0001;
                    const durFactor = 1 - (dur * 0.02); // Slight decrease with duration
                    rates.select[age][dur] = Math.min(baseRate * durFactor * multiplier, 1.0);
                }
                
                // Ultimate rates - used for duration 6+
                const ultimateRate = 0.0001 * Math.exp(0.08 * (age - 20)) + 0.0001;
                rates.ultimate[age] = Math.min(ultimateRate * multiplier, 1.0);
            }
            
            return rates;
        }

        /**
         * Gets mortality rate based on issue age, duration, and basis
         * Implements Duration 1-5 (Select) vs 6+ (Ultimate) logic per spec
         * @param {number} issueAge - Age at policy issue
         * @param {number} duration - Years since policy issue
         * @param {string} basis - Mortality table key (gender-smoker)
         * @returns {number} Annual mortality rate (q_x)
         */
        function getMortalityRate(issueAge, duration, basis) {
            if (!mortalityDataLoaded) {
                throw new Error('Mortality data not loaded. Please wait for data to load.');
            }
            
            const table = mortalityData[basis];
            if (!table) {
                throw new Error(`Invalid mortality basis: ${basis}`);
            }

            // Duration 1-5: Use Select rates at issue age
            if (duration >= 1 && duration <= 5) {
                if (!table.select[issueAge] || !table.select[issueAge][duration]) {
                    throw new Error(`No select rate found for age ${issueAge}, duration ${duration}`);
                }
                return table.select[issueAge][duration];
            }
            
            // Duration 6+: Use Ultimate rates at attained age
            // Attained Age = Issue Age + Duration - 1
            const attainedAge = issueAge + duration - 1;
            if (!table.ultimate[attainedAge]) {
                throw new Error(`No ultimate rate found for attained age ${attainedAge}`);
            }
            return table.ultimate[attainedAge];
        }

        /**
         * Calculates the calculation year from issue date and valuation date
         * @param {Date} issueDate - Policy issue date
         * @param {Date} valuationDate - Reserve valuation date
         * @returns {number} Calculation year (1-based)
         */
        function calculateYear(issueDate, valuationDate) {
            const yearsDiff = valuationDate.getFullYear() - issueDate.getFullYear();
            const monthsDiff = valuationDate.getMonth() - issueDate.getMonth();
            const daysDiff = valuationDate.getDate() - issueDate.getDate();
            
            let calculationYear = yearsDiff + 1;
            
            // If valuation date hasn't reached anniversary, we're still in previous year
            if (monthsDiff < 0 || (monthsDiff === 0 && daysDiff < 0)) {
                calculationYear--;
            }
            
            return Math.max(1, calculationYear);
        }

        /**
         * Validates all input parameters per FR1 requirements
         * @param {Object} params - Input parameters
         * @returns {Object} Validation result with isValid flag and errors array
         */
        function validateInputs(params) {
            const errors = [];
            const { issueAge, term, calculationYear, faceAmount, interestRate, issueDate, valuationDate } = params;

            // Date validation
            if (!issueDate || !valuationDate) {
                errors.push('Both issue date and valuation date are required');
            } else if (valuationDate < issueDate) {
                errors.push('Valuation date must be on or after issue date');
            }

            // Age validation: 18-95
            if (issueAge < 18 || issueAge > 95) {
                errors.push('Issue age must be between 18 and 95');
            }

            // Term validation: 1-40 years
            if (term < 1 || term > 40) {
                errors.push('Term must be between 1 and 40 years');
            }

            // Calculation year validation
            if (calculationYear < 1 || calculationYear > term) {
                errors.push('Valuation date results in calculation year beyond policy term');
            }

            // Face amount validation
            if (faceAmount < 1 || faceAmount > 50000000) {
                errors.push('Face amount must be between $1 and $50,000,000');
            }

            // Interest rate validation
            if (interestRate < 0 || interestRate > 20) {
                errors.push('Interest rate must be between 0% and 20%');
            }

            // Attained age check
            const attainedAge = issueAge + calculationYear - 1;
            if (attainedAge > 95) {
                errors.push('Attained age exceeds maximum of 95');
            }

            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        /**
         * Calculates Present Value of Future Benefits
         * Formula: Sum over remaining term of (Face Amount × q_x × v^t × survival probability)
         * @param {Object} params - Calculation parameters
         * @returns {number} PV of benefits
         */
        function calculatePVBenefits(params) {
            const { issueAge, term, calculationYear, faceAmount, interestRate, basis } = params;
            const v = 1 / (1 + interestRate / 100); // Discount factor
            const remainingTerm = term - calculationYear + 1;
            
            let pvBenefits = 0;
            let survivalProb = 1.0;

            // Start at current calculation year duration
            const startDuration = calculationYear - 1;

            for (let t = 1; t <= remainingTerm; t++) {
                const duration = startDuration + t;
                const qx = getMortalityRate(issueAge, duration, basis);
                
                // Death benefit occurs at end of year t
                pvBenefits += faceAmount * qx * survivalProb * Math.pow(v, t);
                
                // Update survival probability for next year
                survivalProb *= (1 - qx);
            }

            return pvBenefits;
        }

        /**
         * Calculates Present Value of Annuity Due
         * Formula: Sum of (survival probability × v^t) starting at t=0 (annuity due)
         * Implements Fix #1: Correct annuity due timing (beginning of year payments)
         * @param {Object} params - Calculation parameters
         * @returns {number} PV of annuity due
         */
        function calculatePVAnnuityDue(params) {
            const { issueAge, term, calculationYear, interestRate, basis } = params;
            const v = 1 / (1 + interestRate / 100);
            const remainingTerm = term - calculationYear + 1;
            
            let pvAnnuity = 0;
            let survivalProb = 1.0;
            
            // Annuity due: First payment at t=0
            pvAnnuity = 1.0; // Payment at beginning of current year

            const startDuration = calculationYear - 1;

            // Then payments at beginning of each future year
            for (let t = 1; t < remainingTerm; t++) {
                const duration = startDuration + t;
                const qx = getMortalityRate(issueAge, duration, basis);
                
                survivalProb *= (1 - qx);
                pvAnnuity += survivalProb * Math.pow(v, t);
            }

            return pvAnnuity;
        }

        /**
         * Calculates CRVM Reserve with Deficiency Reserve check
         * Implements Fix #3: Deficiency Reserve per NAIC Model 830
         * @param {Object} params - Calculation parameters
         * @returns {Object} Reserve calculation details with audit trail
         */
        function calculateCRVMReserve(params) {
            const { issueAge, term, calculationYear, faceAmount, interestRate, basis } = params;
            const audit = {}; // Audit trail object
            
            // Calculate components
            const pvBenefits = calculatePVBenefits(params);
            const pvAnnuityDue = calculatePVAnnuityDue(params);
            
            // Calculate Net Level Premium at issue (year 1)
            // This is a more accurate approach than using a flat rate
            const issueParams = { ...params, calculationYear: 1 };
            const issuePVBenefits = calculatePVBenefits(issueParams);
            const issuePVAnnuity = calculatePVAnnuityDue(issueParams);
            const netLevelPremium = issuePVBenefits / issuePVAnnuity;
            
            // CRVM = PV(Future Benefits) - Net Level Premium × PV(Future Annuity Due)
            // This represents the excess of future benefits over future premiums
            let crvm = Math.max(0, pvBenefits - (netLevelPremium * pvAnnuityDue));
            
            // Build audit trail
            audit.pvBenefitsCalc = `PV Benefits (Future) = $${pvBenefits.toFixed(2)}`;
            audit.pvAnnuityCalc = `PV Annuity Due (Future) = ${pvAnnuityDue.toFixed(6)}`;
            audit.issuePVBenefits = `PV Benefits (at Issue) = $${issuePVBenefits.toFixed(2)}`;
            audit.issuePVAnnuity = `PV Annuity (at Issue) = ${issuePVAnnuity.toFixed(6)}`;
            audit.premiumCalc = `Net Level Premium = PV Benefits (Issue) / PV Annuity (Issue) = $${issuePVBenefits.toFixed(2)} / ${issuePVAnnuity.toFixed(6)} = $${netLevelPremium.toFixed(2)}`;
            audit.crvmFormula = `CRVM = Max(0, PV Benefits (Future) - Net Level Premium × PV Annuity (Future))`;
            audit.crvmCalc = `CRVM = Max(0, $${pvBenefits.toFixed(2)} - $${netLevelPremium.toFixed(2)} × ${pvAnnuityDue.toFixed(6)})`;
            audit.crvmResult = `CRVM = Max(0, $${pvBenefits.toFixed(2)} - $${(netLevelPremium * pvAnnuityDue).toFixed(2)}) = $${crvm.toFixed(2)}`;
            
            // Deficiency Reserve Check (NAIC 830)
            const duration = calculationYear - 1;
            const qx = getMortalityRate(issueAge, duration + 1, basis);
            const coi = qx * faceAmount; // Cost of insurance
            const remainingTerm = term - calculationYear + 1;
            const coiFloor = (coi / faceAmount) * remainingTerm * faceAmount;
            
            audit.deficiencyDuration = `Duration at valuation = ${duration}`;
            audit.deficiencyQx = `Mortality rate (q_x) = ${(qx * 1000).toFixed(6)}‰`;
            audit.deficiencyCOI = `COI = q_x × Face Amount = ${(qx * 1000).toFixed(6)}‰ × $${faceAmount.toLocaleString()} = $${coi.toFixed(2)}`;
            audit.deficiencyRemaining = `Remaining Term = ${term} - ${calculationYear} + 1 = ${remainingTerm} years`;
            audit.deficiencyFloor = `COI Floor = (COI / Face) × Remaining × Face = $${coiFloor.toFixed(2)}`;
            audit.deficiencyComparison = `CRVM ($${crvm.toFixed(2)}) ${crvm < coiFloor ? '<' : '≥'} COI Floor ($${coiFloor.toFixed(2)})`;
            
            const deficiencyApplied = crvm < coiFloor;
            if (deficiencyApplied) {
                audit.deficiencyAction = `Deficiency reserve applied: Final Reserve = $${coiFloor.toFixed(2)}`;
                crvm = coiFloor;
            } else {
                audit.deficiencyAction = `No deficiency reserve needed: Final Reserve = $${crvm.toFixed(2)}`;
            }

            return {
                crvm: crvm,
                pvBenefits: pvBenefits,
                pvAnnuityDue: pvAnnuityDue,
                deficiencyApplied: deficiencyApplied,
                duration: calculationYear - 1,
                attainedAge: issueAge + calculationYear - 1,
                audit: audit
            };
        }

        /**
         * Generates year-by-year reserve projection
         * Implements Fix #2: Year-by-Year Algorithm with correct duration logic
         * @param {Object} params - Base calculation parameters
         * @returns {Array} Array of year-by-year results
         */
        function generateYearByYear(params) {
            const { term } = params;
            const results = [];

            for (let year = 1; year <= term; year++) {
                const yearParams = { ...params, calculationYear: year };
                const result = calculateCRVMReserve(yearParams);
                
                const duration = year - 1;
                const mortalityRate = getMortalityRate(
                    params.issueAge, 
                    duration + 1, 
                    params.basis
                );

                results.push({
                    year: year,
                    duration: duration,
                    attainedAge: params.issueAge + year - 1,
                    mortalityRate: mortalityRate,
                    reservePer1000: (result.crvm / params.faceAmount) * 1000,
                    totalReserve: result.crvm
                });
            }

            return results;
        }

        /**
         * Main calculation function triggered by UI
         */
        function calculateReserve() {
            // Check if mortality data is loaded
            if (!mortalityDataLoaded) {
                const errorMsg = document.getElementById('errorMessage');
                errorMsg.textContent = 'Error: Mortality data is still loading. Please wait a moment and try again.';
                errorMsg.classList.add('show');
                return;
            }

            // Hide previous results and errors
            document.getElementById('results').classList.remove('show');
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('loading').classList.add('show');

            // Small delay to show loading state
            setTimeout(() => {
                try {
                    // Gather inputs
                    const issueAge = parseInt(document.getElementById('issueAge').value);
                    const gender = document.getElementById('gender').value;
                    const smoker = document.getElementById('smoker').value;
                    const term = parseInt(document.getElementById('term').value);
                    const faceAmount = parseFloat(document.getElementById('faceAmount').value);
                    const interestRate = parseFloat(document.getElementById('interestRate').value);
                    
                    const issueDateStr = document.getElementById('issueDate').value;
                    const valuationDateStr = document.getElementById('valuationDate').value;
                    
                    if (!issueDateStr || !valuationDateStr) {
                        throw new Error('Please enter both issue date and valuation date');
                    }
                    
                    const issueDate = new Date(issueDateStr);
                    const valuationDate = new Date(valuationDateStr);
                    
                    // Calculate the calculation year from dates
                    const calculationYear = calculateYear(issueDate, valuationDate);

                    const basis = `${gender}-${smoker}`;

                    const params = {
                        issueAge,
                        gender,
                        smoker,
                        term,
                        faceAmount,
                        calculationYear,
                        interestRate,
                        basis,
                        issueDate,
                        valuationDate
                    };

                    // Validate inputs
                    const validation = validateInputs(params);
                    if (!validation.isValid) {
                        throw new Error(validation.errors.join('; '));
                    }

                    // Calculate reserve
                    const result = calculateCRVMReserve(params);

                    // Update results display
                    const totalSTAT = result.crvm + result.pvBenefits;
                    
                    document.getElementById('crvmReserve').textContent = 
                        `$${result.crvm.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    document.getElementById('pvBenefits').textContent = 
                        `$${result.pvBenefits.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    document.getElementById('totalSTAT').textContent = 
                        `$${totalSTAT.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    document.getElementById('attainedAge').textContent = result.attainedAge;
                    document.getElementById('calculationYear').textContent = calculationYear;
                    document.getElementById('duration').textContent = result.duration;
                    document.getElementById('deficiency').textContent = 
                        result.deficiencyApplied ? 'Yes' : 'No';
                    
                    // Populate audit trail
                    populateAuditTrail(params, result);

                    // Generate year-by-year table
                    const yearByYear = generateYearByYear(params);
                    const tbody = document.getElementById('yearByYearBody');
                    tbody.innerHTML = '';

                    yearByYear.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.year}</td>
                            <td>${row.duration}</td>
                            <td>${row.attainedAge}</td>
                            <td>${(row.mortalityRate * 1000).toFixed(3)}‰</td>
                            <td>$${row.reservePer1000.toFixed(2)}</td>
                            <td>$${row.totalReserve.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // Show results
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('results').classList.add('show');

                } catch (error) {
                    document.getElementById('loading').classList.remove('show');
                    const errorMsg = document.getElementById('errorMessage');
                    errorMsg.textContent = `Error: ${error.message}`;
                    errorMsg.classList.add('show');
                }
            }, 300);
        }

        /**
         * Populates the audit trail sections with step-by-step calculations
         * @param {Object} params - Calculation parameters
         * @param {Object} result - Calculation results with audit data
         */
        function populateAuditTrail(params, result) {
            const { issueAge, calculationYear, issueDate, valuationDate, basis, faceAmount, term, interestRate } = params;
            const { audit, duration, attainedAge } = result;
            
            // Step 1: Duration Calculation
            const durationAudit = `Issue Date: ${issueDate.toLocaleDateString()}
Valuation Date: ${valuationDate.toLocaleDateString()}
Years Difference: ${valuationDate.getFullYear() - issueDate.getFullYear()} years
Calculation Year: ${calculationYear}
Duration = Calculation Year - 1 = ${calculationYear} - 1 = ${duration}`;
            document.getElementById('auditDuration').textContent = durationAudit;
            
            // Step 2: Attained Age
            const ageAudit = `Issue Age: ${issueAge}
Calculation Year: ${calculationYear}
Attained Age = Issue Age + Calculation Year - 1
Attained Age = ${issueAge} + ${calculationYear} - 1 = ${attainedAge}`;
            document.getElementById('auditAttainedAge').textContent = ageAudit;
            
            // Step 3: Mortality Rate Selection
            const qx = getMortalityRate(issueAge, duration + 1, basis);
            const mortalityType = (duration + 1 <= 5) ? 'Select' : 'Ultimate';
            const lookupAge = (duration + 1 <= 5) ? issueAge : attainedAge;
            const mortalityAudit = `Duration for lookup: ${duration + 1}
Mortality Table: ${basis}
Table Type: ${mortalityType} (Duration ${duration + 1 <= 5 ? '1-5' : '6+'})
${mortalityType === 'Select' ? `Issue Age: ${lookupAge}` : `Attained Age: ${lookupAge}`}
Mortality Rate (q_x): ${(qx * 1000).toFixed(6)}‰ = ${(qx * 100).toFixed(4)}%`;
            document.getElementById('auditMortality').textContent = mortalityAudit;
            
            // Step 4: PV Benefits (detailed example for first 3 years)
            const v = 1 / (1 + interestRate / 100);
            const remainingTerm = term - calculationYear + 1;
            let pvBenefitsDetail = `Face Amount: $${faceAmount.toLocaleString()}
Interest Rate: ${interestRate}%
Discount Factor (v): 1 / (1 + ${interestRate/100}) = ${v.toFixed(6)}
Remaining Term: ${term} - ${calculationYear} + 1 = ${remainingTerm} years

Formula: Σ (Face × q_x × Survival Prob × v^t)

Example calculation (first 3 years):`;
            
            let survivalProb = 1.0;
            const startDuration = calculationYear - 1;
            for (let t = 1; t <= Math.min(3, remainingTerm); t++) {
                const dur = startDuration + t;
                const qxt = getMortalityRate(issueAge, dur, basis);
                const benefit = faceAmount * qxt * survivalProb * Math.pow(v, t);
                pvBenefitsDetail += `\nYear ${t}: $${faceAmount.toLocaleString()} × ${(qxt*1000).toFixed(6)}‰ × ${survivalProb.toFixed(6)} × ${v.toFixed(6)}^${t} = $${benefit.toFixed(2)}`;
                survivalProb *= (1 - qxt);
            }
            if (remainingTerm > 3) {
                pvBenefitsDetail += `\n... (${remainingTerm - 3} more years)`;
            }
            pvBenefitsDetail += `\n\nTotal PV Benefits: $${result.pvBenefits.toFixed(2)}`;
            document.getElementById('auditPVBenefits').textContent = pvBenefitsDetail;
            
            // Step 5: PV Annuity Due
            let pvAnnuityDetail = `Formula: Σ (Survival Prob × v^t) starting at t=0 (annuity due)

Year 0 (current): 1.000000 × ${v.toFixed(6)}^0 = 1.000000`;
            survivalProb = 1.0;
            for (let t = 1; t <= Math.min(3, remainingTerm - 1); t++) {
                const dur = startDuration + t;
                const qxt = getMortalityRate(issueAge, dur, basis);
                survivalProb *= (1 - qxt);
                const annuity = survivalProb * Math.pow(v, t);
                pvAnnuityDetail += `\nYear ${t}: ${survivalProb.toFixed(6)} × ${v.toFixed(6)}^${t} = ${annuity.toFixed(6)}`;
            }
            if (remainingTerm > 4) {
                pvAnnuityDetail += `\n... (${remainingTerm - 4} more years)`;
            }
            pvAnnuityDetail += `\n\nTotal PV Annuity Due: ${result.pvAnnuityDue.toFixed(6)}`;
            document.getElementById('auditPVAnnuity').textContent = pvAnnuityDetail;
            
            // Step 6: CRVM Calculation
            const crvmAudit = `Net Level Premium Calculation (at Issue):
${audit.issuePVBenefits}
${audit.issuePVAnnuity}
${audit.premiumCalc}

Current Reserve Calculation (at Valuation Date):
${audit.pvBenefitsCalc}
${audit.pvAnnuityCalc}

${audit.crvmFormula}
${audit.crvmCalc}
${audit.crvmResult}`;
            document.getElementById('auditCRVM').textContent = crvmAudit;
            
            // Step 7: Deficiency Reserve
            const deficiencyAudit = `${audit.deficiencyDuration}
${audit.deficiencyQx}
${audit.deficiencyCOI}
${audit.deficiencyRemaining}
${audit.deficiencyFloor}

${audit.deficiencyComparison}
${audit.deficiencyAction}`;
            document.getElementById('auditDeficiency').textContent = deficiencyAudit;
        }

        /**
         * Toggles the expansion state of an audit section
         * @param {number} section - Section number (1-7)
         */
        function toggleAudit(section) {
            const content = document.getElementById(`content${section}`);
            const toggle = document.getElementById(`toggle${section}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }

        // Initialize with default dates and load mortality data on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Set default issue date to 5 years ago
            const today = new Date();
            const fiveYearsAgo = new Date(today.getFullYear() - 5, today.getMonth(), today.getDate());
            document.getElementById('issueDate').value = fiveYearsAgo.toISOString().split('T')[0];
            document.getElementById('valuationDate').value = today.toISOString().split('T')[0];
            
            console.log('CRVM Reserve Calculator - Loading mortality data...');
            
            // Disable calculate button while loading
            const calcBtn = document.getElementById('calculateBtn');
            calcBtn.disabled = true;
            calcBtn.textContent = 'Loading Mortality Data...';
            
            // Load mortality data from JSON files
            await loadMortalityData();
            
            // Re-enable calculate button
            calcBtn.disabled = false;
            calcBtn.textContent = 'Calculate Reserve';
            
            if (mortalityDataLoaded) {
                console.log('✓ CRVM Reserve Calculator ready with actual 2017 CSO mortality tables');
            } else {
                console.warn('⚠ Using sample mortality data (production files not found)');
            }
        });
    </script>
</body>
</html>

